!function(y){function T(e,t,a){for(var s="",r=0;r<t.length;r++){var o=y(t[r],e);if(0<o.length&&o[a]&&(s=o.first()[a]()))return s}return s}function A(e){return T(e,["input#ASIN","input#attach-baseAsin",'input[name="designAsin"]'],"val")}function I(e){return e.text()}function l(e,t){var a,s,r=A(e),o=T(e,["#productTitle","h1#title"],"text").trim(),i=(i=T(e,["#centerCol .a-price .a-offscreen","#gc-buy-box .a-color-price"],"text"))||e.find("#twister-plus-price-data-price").val(),n=e.find("#landingImage, #img-canvas img, #ebooks-img-canvas img").attr("src"),d=T(e,["#acrCustomerReviewText",'#gc-detail-page-center-column a[href*="/product-reviews/"]'],"text"),c=e.find("#searchDropdownBox option:selected");(s=c.val())&&(s=s.replace("search-alias=",""),a=c.text());var l,u=[],p=e.find("#productDetails_feature_div,#detailBulletsWrapper_feature_div,#productDetails_detailBullets_sections1,#productDetails_flatSectionTables,#gc-dp-btf-product-features").find('a[href*="/bestsellers/"]');"all"!=s&&"aps"!=s||(c=p.first())&&(l=c.attr("href"))&&(l=l.match(/sellers\/([^\/]+)\//))&&(s=l[1],a=1<(a=c.text().split(/\s(in|en)\s/)).length?a[1]:s),p.each(function(e,t){try{var a=y(t),s=a.parent().text().split(/#|nº/)[1].split(" ");u.push([parseInt(s[0].replace(/\D+/g,"")),s.slice(2).join(" ").split("(")[0],a.prop("href")])}catch(e){}}),u.sort(function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1});var p=(p=e.find("head").text().match(/ue_mid.+'(\w+)/))?p[1]:"",v={name:o,price:i,asin:r,category:s,category_name:a,image:n,url:"https://www.amazon.com/dp/"+r,rating:parseFloat(e.find("#acrPopover").attr("title")),marketplace_id:p,review_count:d?parseInt(d.replace(/,/g,"")||"",10):0,best_sellers_rank:u},h=0,g=0,m=0,f=[];e.find("#vse-vw-dp-vse-related-videos li.a-carousel-card > div").each(function(e,t){var a=y(t),s=a.attr("data-title"),r=a.attr("data-video-image-url-unchanged"),o="https://www.amazon.com"+a.attr("data-vdp-url"),i=a.attr("data-vendor-name").trim(),e=a.attr("data-profile-link"),n="influencer"===(a.attr("data-creator-type")||"").toLowerCase(),t="rvs_g2"===(a.attr("data-group-type")||"").toLowerCase();n&&h++,t&&g++,t&&n&&m++,f.push({title:s||"",image:r||"",url:o,author_name:i||"",author_url:e?"https://www.amazon.com"+e:"",is_influencer:n,duration:a.attr("data-formatted-duration")||"",is_related_video:t,is_customer_review:0<a.find(".IB_G3").length||0<a.find(".G3")||"rvs_g3"===(a.attr("data-group-type")||"").toLowerCase()})}),v.bottom_carousel={videos:f,related_video_count:g,influencer_video_count:h,related_influencer_count:m};var _=[];e.find("[data-a-carousel-options]").each(function(e,t){try{var a=y(t),s=JSON.parse(a.attr("data-a-carousel-options"));if(s&&(s.initialSeenAsins||s.ajax)){var r=a.find("li"),d={products:[],name:"",ajax:{url:s.ajax?s.ajax.url:"",params:s.ajax?s.ajax.params:""},set_size:s.set_size||""},s=a.find("h2.a-carousel-heading").first().text();if(!s)return;d.name=s.trim(),r.each(function(e,t){var a=y(t),s=T(a,[".sponsored-products-truncator-truncated","a div.p13n-sc-truncate-fallback",".a-section span.a-size-base"],"text"),r=T(a,["span.a-color-price",".a-price .a-offscreen"],"text").trim(),o=a.find('i[class*="a-icon-star"]'),i=(n=o.next().text().trim()).length?parseFloat(n.replace(/[^\d.]/g,"")):0,t=o.text().trim();t=(t=t||((t=(o.attr("class")||"").match(/-([\d-]+)/))?t[1]:0))?parseFloat(t.replace("-",".")):0;var n=a.find("img").prop("src"),o=a.find('a[target="_top"],a.a-link-normal').prop("href"),a=decodeURIComponent(o).match(/\/(dp|gp\/product)\/([A-Z0-9]{10})/);s&&a&&d.products.push({name:s,price:r,review_count:i,rating:t,image:n,asin:a&&a[2]?a[2]:"",url:o})}),d.products.length&&_.push(d)}}catch(a){console.log(a)}}),v.product_carousels=_;function w(){b&&x&&t&&t(v)}var b=0,x=0;fetch("https://www.amazon.com/vap/ew/subcomponent/relatedvideos",{method:"POST",headers:{"Content-Type":"application/json","x-requested-with":"XMLHttpRequest"},body:JSON.stringify({pageContext:{page:"DetailPage",placement:"ImageBlock",device:"Desktop",marketplaceID:p,locale:"en_US",product:{contentID:r,contentIDType:"ASIN"}},configuration:{id:"div-relatedvideos",type:"relatedvideos",binder:"relatedvideos",loader:"lazyload",features:{features:{verticalcarousel:"true",hide_default_buttons:"true",first_item_flush_left:"true",pagestate:"dp_vse_rvc",reftagprefix:"dp_vse_ibvc",carouselName:"vse-ib-rvs",count:"6",useLazyLoad:"false",hidePlayIcon:"true",cssClass:"vse-hide-carousel-title",manufacturerVendorCodes:"V3MSA, Z7AX4, 137GO",segmentOneHeaderId:"vse_ib_segment_one",segmentTwoHeaderId:"vse_ib_segment_two",segmentOneHeaderDefault:"Videos for this product",segmentTwoHeaderDefault:"Related videos",segmentThreeHeaderDefault:"Customer review videos",segmentThreeHeaderId:"vse_ib_segment_three",includeProfiles:"true",showCustomerReviewMetadata:"true"}},sources:{source:"VideoAdsDataAggregatorService"}}})}).then(I).then(function(e){try{var t=y(y.parseHTML(e)).find(".vse-video-card"),l=0,u=0,p=0,h=[];t.each(function(e,t){var a=y(t),s=a.find(".vse-video-title-text").text().trim(),r=a.find(".vse-video-image img").attr("src"),o=a.find("a.vse-carousel-item").attr("href"),i=a.find(".vse-video-vendorname").text().trim(),n=a.find(".vse-creator-profile a").attr("href"),d=a.find(".vse-video-duration").text().trim(),c=0<a.find(".vse-video-influencer-profile").length,t=0<a.find(".IB_G2").length||0<a.find(".G2").length;c&&l++,t&&u++,t&&o.is_influencer&&p++,h.push({title:s,image:r,url:"https://www.amazon.com/vdp"+o,author_name:i,author_url:n?"https://www.amazon.com"+n:"",is_influencer:c,duration:d,is_related_video:t,is_customer_review:0<a.find(".IB_G3").length||0<a.find(".G3").length})}),v.top_carousel={videos:h,related_video_count:u,influencer_video_count:l,related_influencer_count:p}}catch(e){}b=1,w()}).catch(function(){b=1,w()}),fetch("https://www.amazon.com/product-reviews/"+r+"/ref=cm_cr_arp_d_viewopt_srt?pageNumber=1&sortBy=recent").then(I).then(function(e){try{var d=[],t=y(y.parseHTML(e)),a=T(t,['.AverageCustomerReviews i[class*="a-icon-star"] span',".AverageCustomerReviews .a-col-right span"],"text");(a=a&&parseFloat(a))&&a!=v.rating&&(v.rating=a),t.find(".review").each(function(e,t){var a=y(t),s=a.find(".a-profile-name").text().trim(),r="https://www.amazon.com"+a.find(".a-profile").attr("href"),o=a.find(".review-date").text().trim(),i=a.find(".review-title").text().trim()||"",n=a.find(".review-text").text().trim()||"",t=parseInt(a.find(".review-rating").text().trim()||"",10),a=0<a.find(".a-color-state").length;d.push({author_name:s||"",author_url:r,date:(o=(o=o||"").match(/on\s(.*)$/))?o[1]:"",title:i,text:n,rating:t,is_verified_purchase:a})}),v.reviews=d}catch(e){}x=1,w()}).catch(function(){x=1,w()})}y(function(){var s,n,v,g,a,m,d,c;A()&&(s=y('<div class="aext-btn"><img src="'+chrome.runtime.getURL("assets/images/icon-64.png")+'" alt="'+chrome.i18n.getMessage("extName")+'"></div>'),y("body").append(s),n=!'<div class="bloading"><div class="lds-ring"><div></div><div></div><div></div><div></div></div><p>Loading Data</p></div>',v="",g=[["luxury","Luxury Stores","5"],["luxury-beauty","Premium Beauty","5"],["luxurystores","Luxury Stores","5"],["garden","Home & Kitchen","4"],["tools","Tools & Home Improvement","4"],["lawngarden","Garden & Outdoor","4"],["pets","Pet Supplies","4"],["electronics","Electronics","3"],["beauty","Beauty & Personal Care","3"],["mi","Musical Instruments","3"],["local-services","Home & Business Services","3"],["digital-music","Digital Music","2.50"],["grocery","Grocery & Gourmet Food","2.50"],["digital-video","Digital Video","2.50"],["book","Book","2.25"],["stripbooks","Books","2.25"],["sporting","Sports & Outdoors","2.25"],["kitchen","Kitchen & Dining","2.25"],["automotive","Automotive Parts & Accessories","2.25"],["baby-products","Baby","2.25"],["fashion","Clothing, Shoes & Jewelry","2"],["fashion-womens","Womens","2"],["fashion-womens-shoes","Womens shoes","2"],["fashion-mens","Mens","2"],["fashion-mens-shoes","Mens Shoes","2"],["fashion-girls","Girls","2"],["fashion-boys","Boys","2"],["fashion-baby","Baby","2"],["fashion-luggage","Luggage & Travel Gear","2"],["fashion-womens-watches","Women's Watches","2"],["fashion-mens-watches","Men's Watches","2"],["fashion-girls-watches","Girls' Watches","2"],["fashion-boys-watches","Boys' Watches","2"],["fashion-womens-accessories","Women's Accessories","2"],["fashion-mens-accessories","Men's Accessories","2"],["fashion-girls-accessories","Girl's Accessories","2"],["fashion-boys-accessories","Boy's Accessories","2"],["toys-and-games","Toys","1.50"],["amazonfresh","Amazon Fresh","1.50"],["computers","Computers","1.25"],["movies-tv","Amazon Fresh","1.25"],["television","Television","1"],["gift-cards","Gift Cards","0"],["mobile-apps","Mobile Apps","0"],["instant-video","Prime Video","0"]],s.on("click",function(){var e,t;n||(a(),v||(t=(e=y(document)).scrollTop(),y("html, body").animate({scrollTop:2*e.height()},2e3).animate({scrollTop:0},1500).animate({scrollTop:t},500),setTimeout(function(){l(y(document),function(e){var t='<?xml version="1.0" ?><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21,8.94a1.31,1.31,0,0,0-.06-.27l0-.09a1.07,1.07,0,0,0-.19-.28h0l-6-6h0a1.07,1.07,0,0,0-.28-.19.32.32,0,0,0-.09,0A.88.88,0,0,0,14.05,2H10A3,3,0,0,0,7,5V6H6A3,3,0,0,0,3,9V19a3,3,0,0,0,3,3h8a3,3,0,0,0,3-3V18h1a3,3,0,0,0,3-3V9S21,9,21,8.94ZM15,5.41,17.59,8H16a1,1,0,0,1-1-1ZM15,19a1,1,0,0,1-1,1H6a1,1,0,0,1-1-1V9A1,1,0,0,1,6,8H7v7a3,3,0,0,0,3,3h5Zm4-4a1,1,0,0,1-1,1H10a1,1,0,0,1-1-1V5a1,1,0,0,1,1-1h3V7a3,3,0,0,0,3,3h3Z" fill="#6563ff"/></svg>';var a=new Date;a.setHours(0,0,0,0),a=a.getTime();for(var s=0,r=0;r<e.reviews.length;r++){var o=e.reviews[r];try{var i=Math.ceil((a-new Date(o.date))/864e5);0<=i&&i<=6&&s++}catch(e){console.log(e)}o.rating,o.date,o.rating,0}v+="<div>",v+='<button class="aext-related-product">Related products</button>',v+="</div>",v+='<div class="aext-area1">',v+='<div class="aext-meta-wraper apad">',v+="<div>",v+="<div><strong>ASIN: </strong><span>"+e.asin+'</span> <button class="aext-copy-button" data-copy="'+e.asin+'">'+t+"</button></div>",v+="<div><strong>Link: </strong><span>"+e.url+'</span> <button class="aext-copy-button" data-copy="'+e.url+'">'+t+"</button></div>",v+="<div><strong>Price: </strong><span>"+e.price+"</span></div>",v+="<div><strong>Rating: </strong><span>"+(e.rating||0)+'</span><span style="color:#ffa41c">★</span></div>',v+="<div><strong># Ratings: </strong><span>"+e.review_count+"</span></div>",v+="</div>";var n=e.best_sellers_rank;v+="<div>",v+="<div><strong>Last 7 days #Reviews: </strong>"+s+"</div>",v+="<div><strong>Best sellers rank</strong></div>";for(r=0;r<n.length;r++){var d=n[r];v+='<div><a href="'+d[2]+'">#'+d[0]+" - "+d[1]+"</a></div>"}v+="</div>",v+="</div>",v+="<table>",v+="<thead>",v+="<tr>",v+="<th></th>",v+="<th>Merchant Videos</th>",v+="<th>Influencer Videos</th>",v+="<th>Total Videos</th>",v+="</tr>",v+="</thead>",v+="<tbody>",v+="<tr>",v+="<td><strong>Top Carrousel</strong></td>",v+="<td>"+(e.top_carousel.videos.length-e.top_carousel.influencer_video_count)+"</td>",v+="<td>"+e.top_carousel.influencer_video_count+"</td>",v+="<td>"+e.top_carousel.videos.length+"</td>",v+="</tr>",v+="<tr>",v+="<td><strong>Bottom Carrousel</strong></td>",v+="<td>"+(e.bottom_carousel.videos.length-e.bottom_carousel.influencer_video_count)+"</td>",v+="<td>"+e.bottom_carousel.influencer_video_count+"</td>",v+="<td>"+e.bottom_carousel.videos.length+"</td>",v+="</tr>",v+="</tbody>",v+="</table>";for(var c="4",r=0;r<g.length;r++)g[r][0]==e.category&&(c=g[r][2]);var l=e.category_name,t=parseInt(e.price.replace(/[\D\.]+/,""));v+='<table class="extbb">',v+="<tr>",v+="<td><strong>Category:</strong> <span>"+l+"</span></td>",v+="<td><strong>Comission % in <span>"+l+"</span> = </strong><span>"+c+"</span>%</td>",v+='<td style="background:#7fff7f">Estimated Comission for this product: <strong>$'+(t=t*c/100)+"</strong></td>",v+="</tr>",v+="</table>",v+="</div>",v+='<div class="aext-area2" style="display:none">',v+='<table class="aext-related-products">',v+="<thead>",v+="<tr>",v+="<th>Image</th>",v+="<th>ASIN</th>",v+="<th>Price</th>",v+='<th>Rating<span style="color:#ffa41c">★</span></th>',v+="<th>Review Count</th>",v+='<th data-tooltip="Total Videos">TV <span class="ii">i</span></th>',v+='<th data-tooltip="Merchant Videos">MV <span class="ii">i</span></th>',v+='<th data-tooltip="Influencer Videos">IV <span class="ii">i</span></th>',v+="</tr>",v+="</thead>",v+="<tbody>";for(r=0;r<e.product_carousels.length;r++)for(var u=e.product_carousels[r],p=0;p<u.products.length;p++){var h=u.products[p];v+='<tr class="loading" data-asin="'+h.asin+'">',v+='<td><a href="https://www.amazon.com/dp/'+h.asin+'" target="_blank"><img src="'+h.image+'"></a></td>',v+='<td><a href="https://www.amazon.com/dp/'+h.asin+'" target="_blank">'+h.asin+"</a>",v+="</td>",v+="<td>"+h.price+"</td>",v+='<td class="rt">'+h.rating+"</td>",v+="<td>"+h.review_count+"</td>",v+='<td class="tv"></td>',v+='<td class="mv"></td>',v+='<td class="iv"></td>',v+="</tr>"}v+="</tbody>",v+="</table>",v+="</div>",m()})},4500)))}),a=function(){!1===n&&(jsPanel.ziBase=9999,n=jsPanel.create({theme:{bgPanel:"#FE6424",bgContent:"#fff",colorHeader:"#fff",border:"thin solid #FE6424",borderRadius:".33rem"},headerLogo:'<img src="'+chrome.runtime.getURL("assets/images/icon-16.png")+'" alt="'+chrome.i18n.getMessage("extName")+'">',headerTitle:"VidPeek",syncMargins:!0,panelSize:{width:()=>Math.min(800,.9*window.innerWidth),height:()=>Math.min(480,.8*window.innerHeight)},css:{panel:"aextPanel"},content:v||'<div class="bloading"><div class="lds-ring"><div></div><div></div><div></div><div></div></div><p>Loading Data</p></div>',onclosed:function(){n=!1}}))},m=function(){n&&y(".jsPanel-content",n).html(v)},y(document).on("click",".aextPanel button[data-copy]",function(e){navigator.clipboard.writeText(y(this).data("copy"))}),c=!(d=function(){var e,t,a,s,r,o,i;!c||0<(e=y("table.aext-related-products tr.loading")).length&&(t=y(e[0],n),a=t.data("asin"),s=function(e){t.find("td.rt").text(e.rating),t.find("td.tv").text(e.top_carousel.videos.length),t.find("td.mv").text(e.top_carousel.videos.length-e.top_carousel.related_video_count),t.find("td.iv").text(e.top_carousel.influencer_video_count),t.removeClass("loading"),d()},r="c-"+a,o=Date.now(),i=o+36e5,chrome.storage.local.get(r,function(e){e=e[r];e&&e._at&&o-e._at<i?s(e):fetch("https://www.amazon.com/dp/"+a).then(I).then(function(e){l(y((new DOMParser).parseFromString(e,"text/html")),function(e){e._at=o;var t={};t[r]=e,chrome.storage.local.set(t),s(e)})})}))}),y(document).on("click",".aextPanel button.aext-related-product",function(e){c?(c=!1,y(".aext-area2",n).hide(),y(".aext-area1",n).show(),y(this).text("Related products")):(c=!0,y(".aext-area1",n).hide(),y(".aext-area2",n).show(),d(),y(this).text("Product details"))}),chrome.runtime.onMessage.addListener(function(e,t,a){"open"===e&&s.click()}))})}(jQuery);